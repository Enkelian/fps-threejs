<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Native three.js with Physics</title>
<!--    <link rel="stylesheet" href="/css/examples.css?ver=1.0.0" />-->
    <script src="./lib/three.js"></script>
    <script src="./lib/enable3d.ammoPhysics.0.20.0.min.js"></script>
    <script src="./lib/OrbitControls.js"></script>
    <script src="./lib/FBXLoader.js"></script>
    <script src="./lib/inflate.min.js"></script>
    <script src="./lib/PointerLockControls.js"></script>

    <style>
      html, body {
        width: 100%;
        height: 100%;
      }

      body {
        /*background-color: #ffffff;*/
        margin: 0;
        overflow: hidden;
        font-family: arial;
      }

      #blocker {

        position: absolute;

        width: 100%;
        height: 100%;

        /*background-color: rgba(0,0,0,0.5);*/

      }

      #instructions {

        width: 100%;
        height: 100%;

        display: -webkit-box;
        display: -moz-box;
        /*display: box;*/

        -webkit-box-orient: horizontal;
        -moz-box-orient: horizontal;
        box-orient: horizontal;

        -webkit-box-pack: center;
        -moz-box-pack: center;
        box-pack: center;

        -webkit-box-align: center;
        -moz-box-align: center;
        box-align: center;

        /*color: #ffffff;*/
        text-align: center;

        cursor: pointer;

      }

    </style>
  </head>

  <body>

    <div id="blocker">

      <div id="instructions">
        <span style="font-size:40px">Click to play</span>
        <br />
        (W, A, S, D = Move, SPACE = Jump, MOUSE = Look around)
      </div>

    </div>

    <script type="module">

      const { AmmoPhysics, PhysicsLoader } = ENABLE3D

      let controls, time = Date.now();

      const MainScene = () => {


        const instructions = document.getElementById( 'instructions' );


        const havePointerLock = 'pointerLockElement' in document || 'mozPointerLockElement' in document || 'webkitPointerLockElement' in document;

        if ( havePointerLock ) {

          const element = document.body;

          const pointerlockchange = function ( event ) {

            if ( document.pointerLockElement === element || document.mozPointerLockElement === element || document.webkitPointerLockElement === element ) {

              controls.enabled = true;


            } else {

              controls.enabled = false;

              instructions.style.display = '';

            }

          }

          const pointerlockerror = function ( event ) {

            instructions.style.display = '';

          }

          // Hook pointer lock state change events
          document.addEventListener( 'pointerlockchange', pointerlockchange, false );
          document.addEventListener( 'mozpointerlockchange', pointerlockchange, false );
          document.addEventListener( 'webkitpointerlockchange', pointerlockchange, false );

          document.addEventListener( 'pointerlockerror', pointerlockerror, false );
          document.addEventListener( 'mozpointerlockerror', pointerlockerror, false );
          document.addEventListener( 'webkitpointerlockerror', pointerlockerror, false );

          instructions.addEventListener( 'click', function ( event ) {

            instructions.style.display = 'none';

            // Ask the browser to lock the pointer
            element.requestPointerLock = element.requestPointerLock || element.mozRequestPointerLock || element.webkitRequestPointerLock;

            if ( /Firefox/i.test( navigator.userAgent ) ) {

              const fullscreenchange = function ( event ) {

                if ( document.fullscreenElement === element || document.mozFullscreenElement === element || document.mozFullScreenElement === element ) {

                  document.removeEventListener( 'fullscreenchange', fullscreenchange );
                  document.removeEventListener( 'mozfullscreenchange', fullscreenchange );

                  element.requestPointerLock();
                }

              }

              document.addEventListener( 'fullscreenchange', fullscreenchange, false );
              document.addEventListener( 'mozfullscreenchange', fullscreenchange, false );

              element.requestFullscreen = element.requestFullscreen || element.mozRequestFullscreen || element.mozRequestFullScreen || element.webkitRequestFullscreen;

              element.requestFullscreen();

            } else {

              element.requestPointerLock();

            }

          }, false );

        } else {

          instructions.innerHTML = 'Your browser doesn\'t seem to support Pointer Lock API';

        }

        const scene = new THREE.Scene()
        scene.background = new THREE.Color(0xf0f0f0)

        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000)
        camera.position.set(0, -7, 0)

        const renderer = new THREE.WebGLRenderer()
        renderer.setSize(window.innerWidth, window.innerHeight)
        document.body.appendChild(renderer.domElement)

        const DPR = window.devicePixelRatio
        renderer.setPixelRatio(Math.min(2, DPR))



        // const controls = new THREE.OrbitControls(camera, renderer.domElement)

        scene.add(new THREE.HemisphereLight(0xffffbb, 0x080820, 1))
        scene.add(new THREE.AmbientLight(0x666666))
        const light = new THREE.DirectionalLight(0xdfebff, 1)
        light.position.set(50, 100, 100)
        light.position.multiplyScalar(1.3)
        scene.add(light)


        const physics = new AmmoPhysics(scene)

        physics.debug.enable(true)

        const { factory } = physics

        const pistol = new THREE.FBXLoader();
        pistol.load( './guns/FBX/Pistol.fbx', object => {
          object.scale.setScalar(0.001);
          object.position.x += 1;
          object.position.y -= 0.5;
          object.position.z -= 2;
          object.rotation.y += 1.5;
          // object.rotation.x -= 0.1;
          object.traverse( function ( child ) {
            // if ( child.isMesh ) {
            //   child.material.wireframe = true;
            // }

            if( child.material ) {
              child.material = new THREE.MeshPhongMaterial({
                color: 0x2E282A,
                emissive: true,
                emissiveIntensity: 0.5
                // vertexColors: THREE.VertexColors
              });
            }

            } );


          camera.add( object );
          // physics.add.existing(object);

        } );


        let mixers = []
        let action;
        let zombieNo = 0;

        function addZombie(position) {
          const zombie = new THREE.FBXLoader();
          zombie.load( './enemies/FBX/Zombie_Female.fbx', object => {

            object.name = 'zombie' + zombieNo++;

            let mixer = new THREE.AnimationMixer(object);
            action = mixer.clipAction(object.animations[8]);
            mixers.push(mixer);
            action.play();

            object.scale.setScalar(0.01);

            object.position.x = position.x
            object.position.y = position.y;
            object.position.z = position.z;
            // object.traverse( function ( child ) {
            //
            // });


            const compound = [
              { shape: 'sphere', radius: 0.65, y: 2.5 },
              { shape: 'box', width: 0.5, height: 0.8, depth: 0.2}
            ]
            physics.add.existing(object, {compound});
            object.body.setCollisionFlags(2);

            scene.add( object );

          } );
        }

        addZombie({x: 0, y: 0.5, z: 10});
        addZombie({x: 0, y: 0.5, z: 15});
        addZombie({x: 10, y: 0.5, z: 10});


        const ground = physics.add.ground({ width: 200, height: 200 }, { lambert: { color: 0x504746 } })
        ground.receiveShadow = true;
        ground.castShadow = true;

        const clock = new THREE.Clock()

        controls = new THREE.PointerLockControls( camera );
        scene.add( controls.getObject() );


        const animate = () => {

          let delta = clock.getDelta();
          if(mixers) {
            mixers.forEach((mixer) => mixer.update(delta));
          }

          physics.update(clock.getDelta() * 10000)

          physics.updateDebugger()
          renderer.render(scene, camera)


          requestAnimationFrame(animate)

          for (let i = 0; i < zombieNo; i++ ){
            let zombie = scene.getObjectByName('zombie' + i);
            if (zombie) {
              // let rand = Math.random() / 100;

              zombie.position.z += Math.random() / 50;

              zombie.body.needUpdate = true

            }
          }
          controls.update( Date.now() - time );

          renderer.render( scene, camera );

          time = Date.now();

        }
        requestAnimationFrame(animate)
      }
      PhysicsLoader('./lib', () => MainScene())
    </script>
  </body>
</html>
